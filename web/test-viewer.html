<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Results Viewer</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="screen active">
        <a href="menu.html" class="back-btn-top-left">← BACK TO MENU</a>
        
        <div class="matrix-container">
            <div class="title">TEST RESULTS VIEWER</div>
            
            <!-- File Selection -->
            <div id="file-selection" class="test-config">
                <div class="config-group">
                    <label>Select Test Result:</label>
                    <select id="test-file-select" class="file-select">
                        <option value="">Loading...</option>
                    </select>
                </div>
                <button id="load-selected-test-btn" class="menu-btn">LOAD TEST</button>
            </div>
            
            <!-- Results Display -->
            <div id="viewer-results" class="viewer-results hidden">
                <div class="viewer-header">
                    <div class="viewer-info">
                        <div>Sequences Tested: <span id="viewer-num-sequences">-</span></div>
                        <div>K Value: <span id="viewer-k-value">-</span></div>
                        <div>Timestamp: <span id="viewer-timestamp">-</span></div>
                        <div>Average Agreement: <span id="viewer-avg-agreement">-</span></div>
                    </div>
                </div>
                
                <!-- Agreement Distribution Chart -->
                <div id="distribution-section" class="distribution-section hidden">
                    <div class="section-title">AGREEMENT DISTRIBUTION</div>
                    <div id="viewer-distribution-bars" class="distribution-bars"></div>
                </div>
                
                <!-- Runtime Comparison Chart -->
                <div id="runtime-section" class="distribution-section hidden">
                    <div class="section-title">AVERAGE RUNTIME COMPARISON</div>
                    <div id="runtime-comparison-chart" class="runtime-comparison-chart"></div>
                </div>
                
                <!-- Individual Results -->
                <div id="viewer-content" class="viewer-content hidden">
                    <div class="section-title">INDIVIDUAL TEST RESULTS</div>
                    <div id="viewer-sequence-list" class="viewer-sequence-list"></div>
                </div>
            </div>
            
            <!-- Detail View for Individual Test Result -->
            <div id="test-detail-view" class="test-detail-view hidden">
                <button id="back-to-list-btn" class="back-btn">← BACK TO LIST</button>
                
                <div class="detail-header">
                    <div class="detail-title">TEST RESULT DETAIL</div>
                    <div class="detail-sequence-id" id="detail-sequence-id"></div>
                    <div class="detail-agreement" id="detail-agreement"></div>
                </div>
                
                <div class="detail-comparison">
                    <div class="detail-column">
                        <div class="detail-column-title">VECTOR KNN RESULTS</div>
                        <div class="detail-runtime" id="detail-vec-runtime"></div>
                        <div id="detail-vec-results" class="detail-results-list"></div>
                    </div>
                    
                    <div class="detail-column">
                        <div class="detail-column-title">NEEDLEMAN-WUNSCH RESULTS</div>
                        <div class="detail-runtime" id="detail-nw-runtime"></div>
                        <div id="detail-nw-results" class="detail-results-list"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="floating-cards" id="floating-cards"></div>
    
    <script src="algorithms.js"></script>
    <script src="app.js"></script>
    <script>
        const app = new GenomeComparisonApp();
        app.createFloatingCards();
        
        // Load list of test files
        fetch('http://localhost:5000/api/list-tests')
            .then(response => response.json())
            .then(files => {
                const select = document.getElementById('test-file-select');
                select.innerHTML = '';
                
                if (files.length === 0) {
                    select.innerHTML = '<option value="">No test results found</option>';
                } else {
                    files.forEach(file => {
                        const option = document.createElement('option');
                        option.value = file.filename;
                        const date = new Date(file.timestamp * 1000);
                        option.textContent = `${file.filename} (${date.toLocaleString()})`;
                        select.appendChild(option);
                    });
                }
                
                // Check if we should auto-load the last test
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('view') === 'last' && files.length > 0) {
                    select.value = files[0].filename;
                    loadSelectedTest();
                }
            })
            .catch(error => {
                console.error('Error loading test list:', error);
                alert('Failed to load test results. Make sure the backend server is running.');
            });
        
        // Load selected test
        document.getElementById('load-selected-test-btn').addEventListener('click', loadSelectedTest);
        
        function loadSelectedTest() {
            const filename = document.getElementById('test-file-select').value;
            if (!filename) return;
            
            fetch(`http://localhost:5000/api/load-test/${filename}`)
                .then(response => response.json())
                .then(data => {
                    displayTestResults(data);
                })
                .catch(error => {
                    console.error('Error loading test:', error);
                    alert('Failed to load test results.');
                });
        }
        
        let currentTestData = null;
        let sequenceData = null;
        
        // Load sequence data for alignments
        fetch('http://localhost:5000/api/sequences')
            .then(response => response.json())
            .then(data => {
                sequenceData = data;
                console.log('Loaded sequence data for alignments');
            })
            .catch(error => console.error('Error loading sequence data:', error));
        
        function displayTestResults(data) {
            currentTestData = data;
            
            // Show results section and hide file selection
            document.getElementById('file-selection').style.display = 'none';
            document.getElementById('viewer-results').classList.remove('hidden');
            
            // Show distribution, runtime, and content sections
            document.getElementById('distribution-section').classList.remove('hidden');
            document.getElementById('runtime-section').classList.remove('hidden');
            document.getElementById('viewer-content').classList.remove('hidden');
            
            // Calculate agreement percentages and runtimes for all sequences
            const agreementPercentages = [];
            let totalVecRuntime = 0;
            let totalNwRuntime = 0;
            for (const [seqId, results] of Object.entries(data.seqs)) {
                const vecIds = new Set(results.vec_knn.returned_knn.map(r => r.id));
                const nwIds = new Set(results.nw_knn.returned_knn.map(r => r.id));
                const agreement = [...vecIds].filter(id => nwIds.has(id)).length;
                const agreementPercent = (agreement / data.header.requested_knn * 100);
                agreementPercentages.push(agreementPercent);
                
                // Accumulate runtimes
                totalVecRuntime += results.vec_knn.runtime;
                totalNwRuntime += results.nw_knn.runtime;
            }
            
            // Calculate average agreement
            const avgAgreement = agreementPercentages.reduce((a, b) => a + b, 0) / agreementPercentages.length;
            
            // Display header info
            document.getElementById('viewer-num-sequences').textContent = data.header.num_sequences;
            document.getElementById('viewer-k-value').textContent = data.header.requested_knn;
            document.getElementById('viewer-timestamp').textContent = new Date(data.header.timestamp).toLocaleString();
            document.getElementById('viewer-avg-agreement').textContent = avgAgreement.toFixed(1) + '%';
            
            // Create distribution chart (10 buckets: 0-10%, 10-20%, ..., 90-100%)
            const distribution = Array(10).fill(0);
            agreementPercentages.forEach(percent => {
                // Handle 100% specially - put it in the last bucket (90-100%)
                const bucket = percent >= 100 ? 9 : Math.floor(percent / 10);
                distribution[bucket]++;
            });
            
            const pieContainer = document.getElementById('viewer-distribution-bars');
            pieContainer.innerHTML = '';
            pieContainer.className = 'pie-chart-container';
            
            // Create SVG pie chart
            const svgNS = 'http://www.w3.org/2000/svg';
            const svg = document.createElementNS(svgNS, 'svg');
            svg.setAttribute('viewBox', '0 0 400 400');
            svg.setAttribute('class', 'pie-chart-svg');
            
            const total = distribution.reduce((a, b) => a + b, 0);
            let currentAngle = -90; // Start at top
            
            // Create pie slices
            distribution.forEach((count, i) => {
                if (count === 0) return;
                
                const percentage = (count / total) * 100;
                const sliceAngle = (count / total) * 360;
                
                // Calculate color gradient: red (0%) -> orange (25%) -> yellow (50%) -> light green (75%) -> green (100%)
                const bucketMidpoint = (i * 10 + (i + 1) * 10) / 2;
                let red, green, blue;
                
                if (bucketMidpoint <= 25) {
                    // Red to Orange (0-25%)
                    red = 255;
                    green = Math.round(165 * (bucketMidpoint / 25));
                    blue = 0;
                } else if (bucketMidpoint <= 50) {
                    // Orange to Yellow (25-50%)
                    red = 255;
                    green = Math.round(165 + 90 * ((bucketMidpoint - 25) / 25));
                    blue = 0;
                } else if (bucketMidpoint <= 75) {
                    // Yellow to Light Green (50-75%)
                    red = Math.round(255 * (1 - (bucketMidpoint - 50) / 25));
                    green = 255;
                    blue = 0;
                } else {
                    // Light Green to Green (75-100%)
                    red = 0;
                    green = 255;
                    blue = 0;
                }
                
                const color = `rgb(${red}, ${green}, ${blue})`;
                
                // Create path for pie slice
                const startAngle = currentAngle;
                const endAngle = currentAngle + sliceAngle;
                
                const startRad = (startAngle * Math.PI) / 180;
                const endRad = (endAngle * Math.PI) / 180;
                
                const x1 = 200 + 150 * Math.cos(startRad);
                const y1 = 200 + 150 * Math.sin(startRad);
                const x2 = 200 + 150 * Math.cos(endRad);
                const y2 = 200 + 150 * Math.sin(endRad);
                
                const largeArc = sliceAngle > 180 ? 1 : 0;
                
                const path = document.createElementNS(svgNS, 'path');
                const pathData = [
                    `M 200 200`,
                    `L ${x1} ${y1}`,
                    `A 150 150 0 ${largeArc} 1 ${x2} ${y2}`,
                    `Z`
                ].join(' ');
                
                path.setAttribute('d', pathData);
                path.setAttribute('fill', color);
                path.setAttribute('stroke', '#00ff00');
                path.setAttribute('stroke-width', '2');
                path.setAttribute('class', 'pie-slice');
                
                // Add tooltip
                const title = document.createElementNS(svgNS, 'title');
                title.textContent = `${i * 10}-${(i + 1) * 10}%: ${count} sequences (${percentage.toFixed(1)}%)`;
                path.appendChild(title);
                
                svg.appendChild(path);
                
                currentAngle = endAngle;
            });
            
            pieContainer.appendChild(svg);
            
            // Create legend
            const legend = document.createElement('div');
            legend.className = 'pie-legend';
            
            distribution.forEach((count, i) => {
                if (count === 0) return;
                
                const bucketMidpoint = (i * 10 + (i + 1) * 10) / 2;
                let red, green, blue;
                
                if (bucketMidpoint <= 25) {
                    // Red to Orange (0-25%)
                    red = 255;
                    green = Math.round(165 * (bucketMidpoint / 25));
                    blue = 0;
                } else if (bucketMidpoint <= 50) {
                    // Orange to Yellow (25-50%)
                    red = 255;
                    green = Math.round(165 + 90 * ((bucketMidpoint - 25) / 25));
                    blue = 0;
                } else if (bucketMidpoint <= 75) {
                    // Yellow to Light Green (50-75%)
                    red = Math.round(255 * (1 - (bucketMidpoint - 50) / 25));
                    green = 255;
                    blue = 0;
                } else {
                    // Light Green to Green (75-100%)
                    red = 0;
                    green = 255;
                    blue = 0;
                }
                
                const color = `rgb(${red}, ${green}, ${blue})`;
                
                const legendItem = document.createElement('div');
                legendItem.className = 'pie-legend-item';
                
                const colorBox = document.createElement('div');
                colorBox.className = 'pie-legend-color';
                colorBox.style.backgroundColor = color;
                
                const label = document.createElement('div');
                label.className = 'pie-legend-label';
                label.textContent = `${i * 10}-${(i + 1) * 10}%: ${count} sequences`;
                
                legendItem.appendChild(colorBox);
                legendItem.appendChild(label);
                legend.appendChild(legendItem);
            });
            
            pieContainer.appendChild(legend);
            
            // Create runtime comparison chart
            const avgVecRuntime = totalVecRuntime / data.header.num_sequences;
            const avgNwRuntime = totalNwRuntime / data.header.num_sequences;
            const maxRuntime = Math.max(avgVecRuntime, avgNwRuntime);
            
            const runtimeChartContainer = document.getElementById('runtime-comparison-chart');
            runtimeChartContainer.innerHTML = '';
            
            // Vector KNN bar
            const vecRuntimeBar = document.createElement('div');
            vecRuntimeBar.className = 'runtime-bar-container';
            
            const vecLabel = document.createElement('div');
            vecLabel.className = 'runtime-label';
            vecLabel.textContent = 'Vector KNN';
            
            const vecBarWrapper = document.createElement('div');
            vecBarWrapper.className = 'runtime-bar-wrapper';
            
            const vecBar = document.createElement('div');
            vecBar.className = 'runtime-bar vec-bar';
            const vecHeightPx = maxRuntime > 0 ? (avgVecRuntime / maxRuntime) * 200 : 0;
            vecBar.style.height = vecHeightPx + 'px';
            
            const vecTime = document.createElement('div');
            vecTime.className = 'runtime-time';
            vecTime.textContent = avgVecRuntime.toFixed(3) + 's';
            
            vecBarWrapper.appendChild(vecBar);
            vecRuntimeBar.appendChild(vecLabel);
            vecRuntimeBar.appendChild(vecBarWrapper);
            vecRuntimeBar.appendChild(vecTime);
            
            // Needleman-Wunsch bar
            const nwRuntimeBar = document.createElement('div');
            nwRuntimeBar.className = 'runtime-bar-container';
            
            const nwLabel = document.createElement('div');
            nwLabel.className = 'runtime-label';
            nwLabel.textContent = 'Needleman-Wunsch';
            
            const nwBarWrapper = document.createElement('div');
            nwBarWrapper.className = 'runtime-bar-wrapper';
            
            const nwBar = document.createElement('div');
            nwBar.className = 'runtime-bar nw-bar';
            const nwHeightPx = maxRuntime > 0 ? (avgNwRuntime / maxRuntime) * 200 : 0;
            nwBar.style.height = nwHeightPx + 'px';
            
            const nwTime = document.createElement('div');
            nwTime.className = 'runtime-time';
            nwTime.textContent = avgNwRuntime.toFixed(3) + 's';
            
            nwBarWrapper.appendChild(nwBar);
            nwRuntimeBar.appendChild(nwLabel);
            nwRuntimeBar.appendChild(nwBarWrapper);
            nwRuntimeBar.appendChild(nwTime);
            
            runtimeChartContainer.appendChild(vecRuntimeBar);
            runtimeChartContainer.appendChild(nwRuntimeBar);
            
            // Display sequence results
            const listContainer = document.getElementById('viewer-sequence-list');
            listContainer.innerHTML = '';
            
            let index = 0;
            for (const [seqId, results] of Object.entries(data.seqs)) {
                const seqCard = document.createElement('div');
                seqCard.className = 'viewer-sequence-card';
                seqCard.style.cursor = 'pointer';
                
                const agreementPercent = agreementPercentages[index++].toFixed(1);
                
                seqCard.innerHTML = `
                    <div class="viewer-seq-header">
                        <span class="viewer-seq-id">${seqId}</span>
                        <span class="viewer-agreement ${agreementPercent >= 70 ? 'high' : agreementPercent >= 40 ? 'medium' : 'low'}">
                            Agreement: ${agreementPercent}%
                        </span>
                    </div>
                    <div class="viewer-seq-times">
                        <span>Vector KNN: ${results.vec_knn.runtime.toFixed(3)}s</span>
                        <span>NW: ${results.nw_knn.runtime.toFixed(3)}s</span>
                    </div>
                `;
                
                // Add click handler to show detail view
                seqCard.addEventListener('click', () => {
                    showDetailView(seqId, results, agreementPercent);
                });
                
                listContainer.appendChild(seqCard);
            }
        }
        
        function showDetailView(seqId, results, agreementPercent) {
            // Hide list view, show detail view
            document.getElementById('viewer-results').classList.add('hidden');
            document.getElementById('test-detail-view').classList.remove('hidden');
            
            // Display header info
            document.getElementById('detail-sequence-id').textContent = `Query Sequence: ${seqId}`;
            document.getElementById('detail-agreement').textContent = `Agreement: ${agreementPercent}%`;
            document.getElementById('detail-vec-runtime').textContent = `Runtime: ${results.vec_knn.runtime.toFixed(3)}s`;
            document.getElementById('detail-nw-runtime').textContent = `Runtime: ${results.nw_knn.runtime.toFixed(3)}s`;
            
            // Find common results between Vector KNN and NW
            const vecIds = new Set(results.vec_knn.returned_knn.map(r => r.id));
            const nwIds = new Set(results.nw_knn.returned_knn.map(r => r.id));
            const commonIds = [...vecIds].filter(id => nwIds.has(id));
            
            // Display Vector KNN results with expandable alignments
            const vecContainer = document.getElementById('detail-vec-results');
            vecContainer.innerHTML = '';
            results.vec_knn.returned_knn.forEach((result, idx) => {
                const isCommon = commonIds.includes(result.id);
                const item = createDetailResultItem(seqId, result, idx + 1, 'vector', isCommon);
                vecContainer.appendChild(item);
            });
            
            // Display NW results with expandable alignments
            const nwContainer = document.getElementById('detail-nw-results');
            nwContainer.innerHTML = '';
            results.nw_knn.returned_knn.forEach((result, idx) => {
                const isCommon = commonIds.includes(result.id);
                const item = createDetailResultItem(seqId, result, idx + 1, 'nw', isCommon);
                nwContainer.appendChild(item);
            });
        }
        
        function createDetailResultItem(queryId, result, rank, algorithmType, isCommon) {
            const item = document.createElement('div');
            item.className = 'detail-result-item' + (isCommon ? ' common' : '');
            
            const uniqueQueryId = `${algorithmType}-detail-query-${result.id}`;
            const uniqueComparedId = `${algorithmType}-detail-compared-${result.id}`;
            
            item.innerHTML = `
                <div class="detail-result-header">
                    <span class="detail-result-rank">#${rank}</span>
                    <span class="detail-result-id">${result.id}</span>
                    <span class="detail-result-similarity">${result.similarity.toFixed(4)}</span>
                    <span class="detail-expand-icon">▼</span>
                </div>
                <div class="detail-result-details" style="display: none;">
                    <div class="sequence-comparison">
                        <div class="sequence-label">Query Sequence (${queryId}):</div>
                        <div class="sequence-display" id="${uniqueQueryId}">Loading...</div>
                        <div class="sequence-label">Compared Sequence (${result.id}):</div>
                        <div class="sequence-display" id="${uniqueComparedId}">Loading...</div>
                    </div>
                </div>
            `;
            
            // Add click handler to expand/collapse and show alignment
            const header = item.querySelector('.detail-result-header');
            const details = item.querySelector('.detail-result-details');
            const icon = item.querySelector('.detail-expand-icon');
            
            header.style.cursor = 'pointer';
            header.addEventListener('click', () => {
                const isExpanded = details.style.display !== 'none';
                
                if (isExpanded) {
                    details.style.display = 'none';
                    icon.textContent = '▼';
                } else {
                    details.style.display = 'block';
                    icon.textContent = '▲';
                    
                    // Display alignment if sequence data is loaded
                    if (sequenceData && app) {
                        const querySeq = sequenceData.sequences.find(s => s.id === queryId);
                        const comparedSeq = sequenceData.sequences.find(s => s.id === result.id);
                        
                        if (querySeq && comparedSeq) {
                            app.displaySequenceDiff(querySeq.sequence, comparedSeq.sequence, uniqueQueryId, uniqueComparedId);
                        } else {
                            document.getElementById(uniqueQueryId).textContent = 'Sequence data not available';
                            document.getElementById(uniqueComparedId).textContent = 'Sequence data not available';
                        }
                    }
                }
            });
            
            return item;
        }
        
        // Back to list button handler
        document.getElementById('back-to-list-btn').addEventListener('click', () => {
            document.getElementById('test-detail-view').classList.add('hidden');
            document.getElementById('viewer-results').classList.remove('hidden');
        });
    </script>
</body>
</html>
